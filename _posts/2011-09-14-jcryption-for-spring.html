---
layout: post
title: jCryption for Spring
date: '2011-09-14T20:51:00.000+02:00'
author: Luca Orlandi
tags:
- spring
- Tech
- crypting
modified_time: '2011-09-27T14:47:01.236+02:00'
thumbnail: http://3.bp.blogspot.com/-A56HfJtGviI/TncwA4KVJXI/AAAAAAAABm4/6LNA_k815Rw/s72-c/json.png
blogger_id: tag:blogger.com,1999:blog-5600070.post-3213540699072380291
blogger_orig_url: http://lrkwz.blogspot.com/2011/09/jcryption-for-spring.html
---

Mi è capitato diverse volte che un cliente mi richiedesse di implementare una forma di criptazione dei dati POSTati dalle form senza utilizzare SSL. Mi sono ripromesso di soprassedere sulla opportunità di questo requisito e sulle effettive caratteristiche di sicurezza di una soluzione basata sul crypting client side in javascript e provvedere ad una implementazione il più possibile solida e semplice.<br /><br />Dopo diverse ricerche sono riuscito ad individuare <a href="http://www.jcryption.org/">jCryption</a>, un piccolo framework javascript/PHP appoggiato su <a href="http://jquery.com/">jQuery</a>.<br /><br />Dato che le applicazioni che realizzo sono normalmente in java basate su <a href="http://www.springframework.com/developer/spring">sprigframework</a> ho messo assieme un modulo di integrazione ragionevolmente semplice da utilizzare.<br /><br />Gli obiettivi di questo modulo sono:<br /><ol><li>evitare l'uso della componente PHP </li><li>evitare di inserire il codice di decrypting all'interno del codice applicativo (decoupling)</li><li>no java coding </li></ol><br />Il sistema nel suo complesso funziona in questa maniera:<br /><table cellpadding="0" cellspacing="0" class="tr-caption-container" style="float: right; margin-left: 1em; text-align: right;"><tbody><tr><td style="text-align: center;"><a href="http://3.bp.blogspot.com/-A56HfJtGviI/TncwA4KVJXI/AAAAAAAABm4/6LNA_k815Rw/s1600/json.png" imageanchor="1" style="clear: right; margin-bottom: 1em; margin-left: auto; margin-right: auto;"><img border="0" height="240" src="http://3.bp.blogspot.com/-A56HfJtGviI/TncwA4KVJXI/AAAAAAAABm4/6LNA_k815Rw/s320/json.png" width="320" /></a></td></tr><tr><td class="tr-caption" style="text-align: center;">JSON call result</td></tr></tbody></table><ol><li>il client al momento della POST chiama un controller che rende (*) la chiave pubblica di codifica</li><li>la libreria javascript crypta tutti i campi della form in una unica stringa di testo che viene POSTata al controller</li><li>un filtro intercetta le chiamate che contengono nel payload la variabile cryptata la decripta&nbsp; e wrappa la richiesta http in modo da servire le medesime variabili della POST originale</li><li>a questo punto la catena dei filtri prosegue come al solito </li></ol><table cellpadding="0" cellspacing="0" class="tr-caption-container" style="float: left; margin-right: 1em; text-align: left;"><tbody><tr><td style="text-align: center;"><a href="http://1.bp.blogspot.com/-_GUI0KlUz_g/Tncw0hMoJNI/AAAAAAAABm8/JL4KjUdZayk/s1600/post.png" imageanchor="1" style="clear: left; margin-bottom: 1em; margin-left: auto; margin-right: auto;"><img border="0" height="209" src="http://1.bp.blogspot.com/-_GUI0KlUz_g/Tncw0hMoJNI/AAAAAAAABm8/JL4KjUdZayk/s320/post.png" width="320" /></a></td></tr><tr><td class="tr-caption" style="text-align: center;">Parametro cryptato</td></tr></tbody></table>(*) La definizione del controller JSON è resa banale dal Spring 3.x: se non lo hai già fatto leggi "<i><a href="http://blog.springsource.com/2010/01/25/ajax-simplifications-in-spring-3-0/">Ajax Simplifications in Spring 3.0</a></i>" ... in poche parole è sufficiente aggiungere una dipendenza al pom.xml e annotare correttamente il controller ... spring è insuperabile per questo!<br /><br />In questo modo è per esempio possibile realizzare una applicazione standard inserendo in pochi punti quanto serve la il crypting; proviamo a farlo passo passo con l'ausilio di <a href="http://www.springsource.org/roo">roo</a>:<br /><br />esegui i seguenti comandi nella shell di roo ini modo da inizializzare una web application che consenta di creare e modificare un oggetto di tipo UserProfile con alcune proprietà<br /><br /><pre class="brush:java">project --topLevelPackage org.gitorious.jcryptionspring.sample<br />persistence setup --database HYPERSONIC_IN_MEMORY --provider HIBERNATE <br />entity --class ~domain.UserProfile<br />field string --class ~domain.UserProfile --fieldName email<br />field string --class ~domain.UserProfile --fieldName name<br />field string --class ~domain.UserProfile --fieldName surname<br />field date --class ~domain.UserProfile --fieldName birthday --type java.util.Calendar<br />field boolean --class ~domain.UserProfile --fieldName enabled<br />logging setup --level DEBUG <br />controller scaffold --class ~.web.UserProfileController <br />security setup<br />dependency add --artifactId jcryption-spring --groupId org.gitorious.jcryptionspring --version 0.1.1 <br />quit<br /></pre><br />lo script precedente aggiunge al pom.xml la dipendenza dal mio modulo di integrazione<br /><br /><pre class="brush: xml">&lt;dependency&gt;<br />            &lt;groupId&gt;org.gitorious.jcryptionspring&lt;/groupId&gt;<br />            &lt;artifactId&gt;jcryption-spring&lt;/artifactId&gt;<br />            &lt;version&gt;0.1.2&lt;/version&gt;<br />&lt;/dependency&gt;<br /></pre><br />a questo punto è necessario aggiungere le librerie javascript che possono essere <a href="http://code.google.com/p/jcryption/downloads/">scaricate dal sito di jCryption</a> (o dai sorgenti su <a href="https://github.com/HazAT/jCryption">github</a>).<br /><br />Modifica il file src/main/webapp/WEB-INF/layouts/default.jspx in modo che le librerie js vengano incluse in ogni pagina<br /><br /><pre class="brush:html">&lt;spring:url var="home" value="/" /&gt;<br />&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <br />&lt;script src="${home }js/jquery-1.4.2.min.js" type="text/javascript"&gt;&lt;!--&nbsp; --&gt;&lt;/script&gt;&nbsp; <br />&lt;script src="${home }js/jquery-ui-1.8.2.custom.min.js" type="text/javascript"&gt;&lt;!--&nbsp; --&gt;&lt;/script&gt;&nbsp; <br />&lt;script type="text/javascript"&nbsp;&nbsp;&nbsp; src="${home }js/security/jquery.jcryption-1.2.js"&gt;&lt;!--&nbsp; --&gt;&lt;/script&gt;<br /></pre><br />A questo punto bisogna agganciare la funzione di crypting alla post di ciascuna form (p.e. src/main/webapp/WEB-INF/views/userprofiles/create.jspx e src/main/webapp/WEB-INF/views/userprofiles/update.jspx) inserendo :<br /><br /><pre class="brush:javascript">&lt;spring:url value="/EncryptionServlet?generateKeypair=true"  var="getKeysURL"/&gt;<br />&lt;script&gt;  <br />/*&lt;![CDATA[ */  <br /><br />$(function() {<br /><br />$("#userProfile").jCryption({getKeysURL:"${getKeysURL}"});<br /><br />});<br />/*]]&gt;*/<br />&lt;/script&gt;&nbsp;</pre><br />per fare in modo che la chiamata&nbsp; /EncryptionServlet abbia luogo puoi aggiungere alla configurazione mvc src/main/webapp/WEB-INF/spring/webmvc-config.xml:<br /><br /><pre class="brush:xml">&lt;context:component-scan base-package="org.gitorious.jcryptionspring"&gt;<br />&lt;/context:component-scan&gt;<br /></pre><br />infine è necessario configurare il filtro di decripting nel src/main/webapp/WEB-INF/web.xml inserendo<br /><br /><pre class="brush:xml">&lt;filter&gt;<br />    &lt;filter-name&gt;DecryptParameters&lt;/filter-name&gt;  <br />    &lt;filter-class&gt;org.gitorious.jcryptionspring.ParameterDecryptingFilter&lt;/filter-class&gt;  <br />&lt;/filter&gt;  <br />&lt;filter-mapping&gt;  <br />    &lt;filter-name&gt;DecryptParameters&lt;/filter-name&gt;  <br />    &lt;url-pattern&gt;/*&lt;/url-pattern&gt;  <br />&lt;/filter-mapping&gt;<br /></pre><br />prima del CharacterEncodingFilter in maniera che l'ordine dei filtri resti inalterato (lo Spring OpenEntityManagerInViewFilter deve rimanere al suo posto per non incorrere nel fatidico "<a href="http://www.google.com/search?client=ubuntu&amp;channel=fs&amp;q=%3Cfilter%3E%3Cfilter-name%3EDecryptParameters%3C%2Ffilter-name%3E%3Cfilter-class%3Eorg.gitorious.jcryptionspring.ParameterDecryptingFilter%3C%2Ffilter-class%3E%3C%2Ffilter%3E%3Cfilter-mapping%3E%3Cfilter-name%3EDecryptParameters%3C%2Ffilter-name%3E%3Curl-pattern%3E%2F*%3C%2Furl-pattern%3E%3C%2Ffilter-mapping%3E&amp;ie=utf-8&amp;oe=utf-8#sclient=psy-ab&amp;hl=en&amp;client=ubuntu&amp;hs=bDY&amp;channel=fs&amp;source=hp&amp;q=detached+entity+passed+to+persist&amp;pbx=1&amp;oq=detached+entity+passed+to+persist">Detached entry passed to persist</a>"<br /><br />Semplice no?<br /><br />Il package compilato è disponibile sul repository central di maven e i sorgenti (compreso un esempio funzionante) su <a href="http://gitorious.org/jcryptingspring">gitorious</a>.